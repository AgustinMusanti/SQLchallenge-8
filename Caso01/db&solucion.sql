IF OBJECT_ID('dbo.ventas','U') 
IS NOT NULL DROP TABLE dbo.ventas;

CREATE TABLE dbo.ventas (
  id         INT PRIMARY KEY,
  cliente_id VARCHAR(10) NOT NULL,
  fecha      DATE NOT NULL,
  monto      DECIMAL(10,2) NOT NULL
);

INSERT INTO dbo.ventas
VALUES
(1,'C001','2025-08-03',180.00),
(2,'C001','2025-08-21',220.00),
(3,'C001','2025-09-05',210.00),
(4,'C001','2025-09-18',190.00),
(5,'C002','2025-08-07',95.00),
(6,'C002','2025-08-25',130.00),
(7,'C002','2025-09-04',140.00),
(8,'C002','2025-09-22',160.00),
(9,'C003','2025-08-10',300.00),
(10,'C003','2025-08-29',150.00),
(11,'C003','2025-09-02',200.00),
(12,'C003','2025-09-27',240.00),
(13,'C004','2025-08-02',80.00),
(14,'C004','2025-08-19',120.00),
(15,'C004','2025-09-09',90.00),
(16,'C004','2025-09-26',110.00),
(17,'C005','2025-08-11',500.00),
(18,'C005','2025-08-30',220.00),
(19,'C005','2025-09-07',350.00),
(20,'C005','2025-09-15',260.00),
(21,'C006','2025-08-05',140.00),
(22,'C006','2025-08-23',180.00),
(23,'C006','2025-09-12',170.00),
(24,'C006','2025-09-29',200.00),
(25,'C007','2025-08-08',90.00),
(26,'C007','2025-08-28',95.00),
(27,'C007','2025-09-06',100.00),
(28,'C007','2025-09-21',105.00),
(29,'C008','2025-08-14',260.00),
(30,'C008','2025-08-31',140.00),
(31,'C008','2025-09-03',200.00),
(32,'C008','2025-09-25',160.00),
(33,'C009','2025-08-01',70.00),
(34,'C009','2025-08-20',60.00),
(35,'C010','2025-08-06',180.00),
(36,'C010','2025-08-24',150.00),
(37,'C011','2025-08-09',95.00),
(38,'C011','2025-08-27',85.00),
(39,'C012','2025-08-12',300.00),
(40,'C012','2025-08-22',130.00),
(41,'C019','2025-08-13',210.00),
(42,'C019','2025-08-18',190.00),
(43,'C013','2025-09-01',120.00),
(44,'C013','2025-09-19',140.00),
(45,'C014','2025-09-08',200.00),
(46,'C014','2025-09-24',220.00),
(47,'C015','2025-09-10',80.00),
(48,'C015','2025-09-28',95.00),
(49,'C016','2025-09-11',260.00),
(50,'C016','2025-09-23',180.00),
(51,'C020','2025-09-13',300.00),
(52,'C020','2025-09-17',150.00),
(53,'C017','2025-08-04',160.00),
(54,'C017','2025-08-26',140.00),
(55,'C017','2025-09-14',200.00),
(56,'C017','2025-09-30',180.00),
(57,'C018','2025-08-15',400.00),
(58,'C018','2025-08-16',220.00),
(59,'C018','2025-09-16',320.00),
(60,'C018','2025-09-20',250.00);
GO


-- Soluci√≥n:
    
DECLARE @mes1 CHAR(7) = '2025-08';
DECLARE @mes2 CHAR(7) = '2025-09';

WITH compras_mensuales AS (
  SELECT
    cliente_id,
    CONCAT(YEAR(fecha), '-', RIGHT('0' + CAST(MONTH(fecha) AS VARCHAR(2)), 2)) AS mes
  FROM dbo.ventas
  WHERE CONCAT(YEAR(fecha), '-', RIGHT('0' + CAST(MONTH(fecha) AS VARCHAR(2)), 2)) IN (@mes1, @mes2)
  GROUP BY cliente_id, CONCAT(YEAR(fecha), '-', RIGHT('0' + CAST(MONTH(fecha) AS VARCHAR(2)), 2))
),
marcas AS (
  SELECT
    cliente_id,
    MAX(CASE WHEN mes = @mes1 THEN 1 ELSE 0 END) AS compro_mes1,
    MAX(CASE WHEN mes = @mes2 THEN 1 ELSE 0 END) AS compro_mes2
  FROM compras_mensuales
  GROUP BY cliente_id
)
SELECT
  SUM(compro_mes1) AS ClientesMes1,
  SUM(compro_mes2) AS ClientesMes2,
  SUM(CASE WHEN compro_mes1 = 1 AND compro_mes2 = 1 THEN 1 ELSE 0 END) AS ClientesRetenidos,
  CAST(
    ROUND(
      100.0 * SUM(CASE WHEN compro_mes1 = 1 AND compro_mes2 = 1 THEN 1 ELSE 0 END)
      / NULLIF(SUM(compro_mes1), 0),
      2
    ) AS DECIMAL(6,2)
  ) AS TasaRetencionPct
FROM marcas;



